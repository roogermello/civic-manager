<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Civic Manager G9</title>
    
    <!-- Configurações de Web App (PWA Feeling) -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Civic Mgr">
    
    <!-- Ícones -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/55/55283.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/55/55283.png">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuração do Tema -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        civic: {
                            dark: '#0f172a',
                            panel: '#1e293b',
                            cyan: '#06b6d4',
                            red: '#ef4444',
                            text: '#e2e8f0'
                        }
                    },
                    animation: {
                        'slide-left': 'slideLeft 0.25s ease-out',
                        'slide-right': 'slideRight 0.25s ease-out',
                    },
                    keyframes: {
                        slideLeft: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        slideRight: { '0%': { transform: 'translateX(-100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            touch-action: pan-y; 
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            will-change: transform, opacity;
        }

        input, select, textarea {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            outline: none;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #06b6d4;
        }

        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #22c55e;
        }

        .critical-row {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .nav-item.active {
            color: #06b6d4;
            border-top: 2px solid #06b6d4;
        }
        
        .toggle-btn {
            @apply px-3 py-1 text-xs font-bold rounded-full transition-colors border border-gray-600 text-gray-400;
        }
        .toggle-btn.active {
            @apply bg-civic-cyan text-slate-900 border-civic-cyan;
        }

        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; width: 90%; max-width: 400px; pointer-events: none;
        }
        .toast {
            background: rgba(15, 23, 42, 0.95); border: 1px solid #06b6d4; color: white;
            padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            margin-bottom: 0.5rem; opacity: 0; transform: translateY(-20px);
            transition: all 0.3s ease-out; pointer-events: auto; display: flex; align-items: center; gap: 10px;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
    </style>
</head>
<body id="app-body">

    <div id="toast-container"></div>

    <!-- Header -->
    <header class="p-4 flex justify-between items-center bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-car-side text-civic-cyan text-2xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wider">CIVIC <span class="text-civic-cyan">MANAGER</span></h1>
                <p class="text-xs text-gray-400">Geração 9</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xs text-gray-400">Hodômetro</p>
            <div class="flex items-center gap-2" onclick="editOdometer()">
                <span id="headerOdometer" class="font-mono text-xl font-bold text-white">0</span> <span class="text-xs">km</span>
                <i class="fa-solid fa-pen text-xs text-gray-500 cursor-pointer"></i>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-3xl mx-auto min-h-[80vh]">
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view-section space-y-4">
            <!-- ALERTA DE ÓLEO -->
            <div id="oilStatusCard" class="glass-panel p-4 rounded-xl shadow-lg border-l-4 transition-all duration-300">
                <div class="flex justify-between items-center animate-pulse">
                    <span class="text-gray-400">Carregando...</span>
                </div>
            </div>

            <!-- Cards Resumo -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-4 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <p class="text-xs text-gray-400 uppercase">Manutenção</p>
                    <h3 class="text-xl font-bold mt-1 text-white" id="totalMaintenance">R$ 0,00</h3>
                </div>
                <div class="glass-panel p-4 rounded-xl shadow-lg border-t-4 border-purple-500">
                    <p class="text-xs text-gray-400 uppercase">Upgrades</p>
                    <h3 class="text-xl font-bold mt-1 text-white" id="totalUpgrades">R$ 0,00</h3>
                </div>
                <div class="glass-panel p-4 rounded-xl shadow-lg border-t-4 border-green-500 col-span-2">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-gray-400 uppercase">Eficiência Média (Geral)</p>
                            <h3 class="text-2xl font-bold mt-1 text-white" id="avgConsumption">-- km/L</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Custo/KM</p>
                            <p class="text-lg font-bold text-green-400" id="costPerKm">R$ 0,00</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico Evolução -->
            <div class="glass-panel p-4 rounded-xl mt-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-300">Evolução de Combustível</h3>
                    <div class="flex gap-2">
                        <button onclick="setFuelChartMode('week')" id="btn-week" class="toggle-btn">Semana</button>
                        <button onclick="setFuelChartMode('month')" id="btn-month" class="toggle-btn active">Mês</button>
                    </div>
                </div>
                <div class="h-64 relative">
                    <canvas id="fuelTrendChart"></canvas>
                </div>
            </div>

            <!-- Gráfico Distribuição -->
            <div class="glass-panel p-4 rounded-xl mt-4">
                <h3 class="text-sm font-bold mb-4 text-gray-300">Distribuição de Gastos</h3>
                <div class="h-[200px] relative">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <button onclick="exportData()" class="w-full mt-6 py-3 text-xs text-gray-500 hover:text-white border border-dashed border-gray-700 rounded-lg">
                <i class="fa-solid fa-download mr-2"></i> Exportar Dados (Backup JSON)
            </button>
        </section>

        <!-- MANUTENÇÃO VIEW -->
        <section id="view-maintenance" class="view-section hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-civic-cyan">Histórico de Serviços</h2>
                <button onclick="openModal('maintenance')" class="bg-civic-cyan text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-cyan-400 transition">
                    <i class="fa-solid fa-plus mr-1"></i> Novo
                </button>
            </div>
            <div id="maintenanceList" class="space-y-3 pb-20"></div>
        </section>

        <!-- ABASTECIMENTO VIEW -->
        <section id="view-fuel" class="view-section hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-green-400">Controle de Combustível</h2>
                <button onclick="openModal('fuel')" class="bg-green-500 text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-green-400 transition">
                    <i class="fa-solid fa-gas-pump mr-1"></i> Abastecer
                </button>
            </div>
            <div id="fuelList" class="space-y-3 pb-20"></div>
        </section>

        <!-- UPGRADES VIEW -->
        <section id="view-garage" class="view-section hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-purple-400">Garagem & Upgrades</h2>
                <button onclick="openModal('garage')" class="bg-purple-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-400 transition">
                    <i class="fa-solid fa-screwdriver-wrench mr-1"></i> Adicionar
                </button>
            </div>
            <div id="garageList" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-20"></div>
        </section>

    </main>

    <!-- Nav -->
    <nav class="fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 flex justify-around py-3 z-50 shadow-2xl pb-[env(safe-area-inset-bottom)]">
        <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center text-gray-500 w-1/4 select-none touch-manipulation">
            <i class="fa-solid fa-chart-pie mb-1 text-lg"></i>
            <span class="text-[10px]">Resumo</span>
        </button>
        <button onclick="switchView('maintenance')" class="nav-item flex flex-col items-center text-gray-500 w-1/4 select-none touch-manipulation">
            <i class="fa-solid fa-wrench mb-1 text-lg"></i>
            <span class="text-[10px]">Manutenção</span>
        </button>
        <button onclick="switchView('fuel')" class="nav-item flex flex-col items-center text-gray-500 w-1/4 select-none touch-manipulation">
            <i class="fa-solid fa-gas-pump mb-1 text-lg"></i>
            <span class="text-[10px]">Combustível</span>
        </button>
        <button onclick="switchView('garage')" class="nav-item flex flex-col items-center text-gray-500 w-1/4 select-none touch-manipulation">
            <i class="fa-solid fa-basket-shopping mb-1 text-lg"></i>
            <span class="text-[10px]">Upgrades</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="maintenanceModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 relative">
            <button onclick="toggleModal('maintenanceModal')" class="absolute top-4 right-4 text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4" id="mModalTitle">Nova Manutenção</h3>
            <form id="formMaintenance" onsubmit="handleMaintenanceSubmit(event)" class="space-y-3">
                <input type="date" id="mDate" required>
                <input type="number" id="mKm" placeholder="Quilometragem" required>
                <select id="mType" required>
                    <option value="" disabled selected>Tipo de Serviço</option>
                    <option value="Troca de Óleo">Troca de Óleo Motor</option>
                    <option value="Filtros">Filtros</option>
                    <option value="Câmbio Automático">Câmbio Automático</option>
                    <option value="Freios">Freios</option>
                    <option value="Suspensão">Suspensão</option>
                    <option value="Pneus">Pneus</option>
                    <option value="Outros">Outros</option>
                </select>
                <input type="text" id="mShop" placeholder="Oficina / Mecânico">
                <input type="number" step="0.01" id="mCost" placeholder="Valor Total (R$)" required>
                <textarea id="mNotes" rows="2" placeholder="Observações"></textarea>
                <button type="submit" id="mSubmitBtn" class="w-full bg-civic-cyan text-slate-900 font-bold py-3 rounded-lg mt-2">Salvar</button>
            </form>
        </div>
    </div>

    <div id="fuelModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 relative">
            <button onclick="toggleModal('fuelModal')" class="absolute top-4 right-4 text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4" id="fModalTitle">Novo Abastecimento</h3>
            <form id="formFuel" onsubmit="handleFuelSubmit(event)" class="space-y-3">
                <input type="date" id="fDate" required>
                <input type="number" id="fKm" placeholder="KM Atual" required>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] text-gray-400 pl-1">Litros</label><input type="number" step="0.01" id="fLiters" placeholder="0.00 L" oninput="calcFuelTotal('liters')" required></div>
                    <div><label class="text-[10px] text-gray-400 pl-1">Preço/L</label><input type="number" step="0.001" id="fPrice" placeholder="R$ 0.00" oninput="calcFuelTotal('price')"></div>
                </div>
                <div><label class="text-[10px] text-gray-400 pl-1">Total</label><input type="number" step="0.01" id="fTotal" placeholder="R$ 0.00" oninput="calcFuelTotal('total')" required></div>
                <div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700 mt-2">
                    <input type="checkbox" id="fFullTank">
                    <label for="fFullTank" class="text-sm text-gray-300 cursor-pointer flex-1">Tanque Cheio?<span class="block text-[10px] text-gray-500">Calcula consumo (km/L)</span></label>
                    <i class="fa-solid fa-gas-pump text-green-500 text-lg"></i>
                </div>
                <button type="submit" id="fSubmitBtn" class="w-full bg-green-500 text-slate-900 font-bold py-3 rounded-lg mt-2">Salvar</button>
            </form>
        </div>
    </div>

    <div id="garageModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 relative">
            <button onclick="toggleModal('garageModal')" class="absolute top-4 right-4 text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4" id="gModalTitle">Novo Item</h3>
            <form id="formGarage" onsubmit="handleGarageSubmit(event)" class="space-y-3">
                <input type="text" id="gItem" placeholder="Item" required>
                <select id="gStatus" required>
                    <option value="Desejo">Desejo</option>
                    <option value="Comprado">Comprado</option>
                    <option value="Instalado">Instalado</option>
                </select>
                <input type="number" step="0.01" id="gCost" placeholder="Custo">
                <input type="url" id="gLink" placeholder="Link">
                <input type="url" id="gImage" placeholder="Imagem URL">
                <button type="submit" id="gSubmitBtn" class="w-full bg-purple-500 text-white font-bold py-3 rounded-lg mt-2">Salvar</button>
            </form>
        </div>
    </div>

    <!-- JS OTIMIZADO -->
    <script>
        // --- CONSTANTS & STATE ---
        const DB_KEYS = { MAINT: 'civic_m', FUEL: 'civic_f', GARAGE: 'civic_g', ODO: 'civic_o' };
        const OIL_KM = 10000;
        const ALERT_KM = 2000;

        let appData = { maintenance: [], fuel: [], garage: [], odometer: 0 };
        let charts = { expense: null, trend: null };
        let currentFuelMode = 'month';
        let editingState = { type: null, index: null }; // Controle de Edição

        // --- INIT ---
        try {
            appData = {
                maintenance: JSON.parse(localStorage.getItem(DB_KEYS.MAINT)) || [],
                fuel: JSON.parse(localStorage.getItem(DB_KEYS.FUEL)) || [],
                garage: JSON.parse(localStorage.getItem(DB_KEYS.GARAGE)) || [],
                odometer: localStorage.getItem(DB_KEYS.ODO) || 0
            };
        } catch(e) { console.error("Data Reset", e); localStorage.clear(); }

        window.addEventListener('DOMContentLoaded', () => {
            renderDashboard(); // Renderiza apenas o dashboard inicialmente
            setTodayDates();
        });

        // --- CORE RENDER FUNCTIONS (BATCH RENDER) ---
        
        function renderDashboard() {
            document.getElementById('headerOdometer').innerText = parseInt(appData.odometer).toLocaleString('pt-BR');
            updateDashboardStats();
            checkOilStatus();
            setTimeout(() => {
                initOrUpdateCharts();
            }, 50);
        }

        function renderMaintenanceList() {
            const container = document.getElementById('maintenanceList');
            // Remove check de dirty simples para garantir update visual após edição
            
            const sorted = [...appData.maintenance].map((item, index) => ({...item, originalIndex: index})).sort((a, b) => new Date(b.date) - new Date(a.date));
            if(sorted.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-10">Nenhum registro.</p>';
                return;
            }

            const html = sorted.map(item => {
                const isCrit = item.type === 'Câmbio Automático';
                return `
                <div class="glass-panel p-3 rounded-lg relative ${isCrit ? 'critical-row' : 'border-l-4 border-blue-500'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs text-gray-400 font-mono">${formatDate(item.date)} • ${parseInt(item.km).toLocaleString()} km</span>
                            <h4 class="font-bold text-white ${isCrit ? 'text-red-400' : ''}">${item.type}</h4>
                            <p class="text-sm text-gray-300">${item.shop || ''}</p>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <p class="font-bold text-civic-cyan">${formatCurrency(item.cost)}</p>
                            <div class="mt-2 flex gap-3">
                                <button onclick="editItem('maintenance', ${item.originalIndex})" class="text-xs text-blue-400 opacity-70 hover:opacity-100"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteItem('maintenance', ${item.originalIndex})" class="text-xs text-red-500 opacity-70 hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderFuelList() {
            const container = document.getElementById('fuelList');
            const sorted = [...appData.fuel].map((item, index) => ({...item, originalIndex: index})).sort((a, b) => b.km - a.km);
            
            if(sorted.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-10">Nenhum registro.</p>';
                return;
            }

            const html = sorted.map((item, i) => {
                let eff = '-';
                const prev = sorted[i+1];
                if(item.fullTank && prev) {
                    const kmL = (item.km - prev.km) / item.liters;
                    eff = kmL.toFixed(1) + ' km/L';
                }
                const icon = item.fullTank ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : '<i class="fa-regular fa-circle text-gray-600"></i>';
                
                return `
                <div class="glass-panel p-3 rounded-lg border-l-4 border-green-500 flex justify-between items-center">
                    <div>
                        <span class="text-xs text-gray-400 font-mono flex items-center gap-1">${formatDate(item.date)} • ${parseInt(item.km).toLocaleString()} ${icon}</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h4 class="font-bold text-white">${item.liters} L</h4>
                            <span class="text-xs text-green-400 font-bold bg-green-900/30 px-2 rounded">${eff}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-white">${formatCurrency(item.total)}</p>
                        <div class="mt-2 flex gap-3 justify-end">
                            <button onclick="editItem('fuel', ${item.originalIndex})" class="text-xs text-blue-400 opacity-70 hover:opacity-100"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteItem('fuel', ${item.originalIndex})" class="text-xs text-red-500 opacity-70 hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;
        }

        function renderGarageList() {
            const container = document.getElementById('garageList');
            if(appData.garage.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-2 mt-10">Garagem vazia.</p>';
                return;
            }

            const html = appData.garage.map((item, i) => {
                let color = item.status === 'Comprado' ? 'bg-yellow-600' : (item.status === 'Instalado' ? 'bg-purple-600' : 'bg-gray-600');
                return `
                <div class="glass-panel rounded-lg overflow-hidden flex flex-col h-full">
                    ${item.image ? `<div class="h-24 bg-cover bg-center" style="background-image: url('${item.image}')"></div>` : ''}
                    <div class="p-3 flex-1 flex flex-col">
                        <div class="flex justify-between mb-2">
                            <span class="text-[10px] uppercase font-bold text-white px-2 py-0.5 rounded ${color}">${item.status}</span>
                            <div class="flex gap-2">
                                <button onclick="editItem('garage', ${i})" class="text-blue-400 text-xs"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteItem('garage', ${i})" class="text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <h4 class="font-bold text-white leading-tight">${item.item}</h4>
                        <p class="text-civic-cyan font-bold mt-auto">${item.cost > 0 ? formatCurrency(item.cost) : '-'}</p>
                    </div>
                </div>`;
            }).join('');
            
            container.innerHTML = html;
        }

        // --- CHARTS OPTIMIZATION (UPDATE INSTEAD OF DESTROY) ---
        function initOrUpdateCharts() {
            if(document.getElementById('view-dashboard').classList.contains('hidden')) return;

            updateExpenseChartData();
            updateFuelTrendData(currentFuelMode);
        }

        function updateExpenseChartData() {
            const ctx = document.getElementById('expenseChart');
            if(!ctx) return;
            
            const totals = [
                appData.maintenance.reduce((a,c) => a + Number(c.cost), 0),
                appData.fuel.reduce((a,c) => a + Number(c.total), 0),
                appData.garage.reduce((a,c) => a + Number(c.cost), 0)
            ];

            if(charts.expense) {
                charts.expense.data.datasets[0].data = totals;
                charts.expense.update();
            } else {
                charts.expense = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Manutenção', 'Combustível', 'Upgrades'],
                        datasets: [{ data: totals, backgroundColor: ['#3b82f6', '#22c55e', '#a855f7'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
                });
            }
        }

        function updateFuelTrendData(mode) {
            const ctx = document.getElementById('fuelTrendChart');
            if(!ctx) return;

            // Process Data
            let sorted = [...appData.fuel].sort((a, b) => new Date(a.date) - new Date(b.date));
            let grouped = {};
            
            sorted.forEach((item, i) => {
                let dist = 0;
                if(i > 0) dist = item.km - sorted[i-1].km;
                if(dist < 0) dist = 0;
                
                let d = new Date(item.date);
                let key = '';
                let label = '';

                if(mode === 'month') {
                    key = item.date.substring(0,7); 
                    label = d.toLocaleDateString('pt-BR',{month:'short'});
                } else {
                    // Week Logic: Group by Monday of that week
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
                    const monday = new Date(d.setDate(diff));
                    key = monday.toISOString().substring(0,10);
                    label = `${monday.getDate().toString().padStart(2,'0')}/${(monday.getMonth()+1).toString().padStart(2,'0')}`;
                }

                if(!grouped[key]) grouped[key] = { label, cost: 0, liters: 0, dist: 0, date: key }; // Use key as sortable date
                grouped[key].cost += item.total;
                grouped[key].liters += item.liters;
                grouped[key].dist += dist;
            });

            let data = Object.values(grouped).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-4);
            const labels = data.map(d => d.label);
            const costs = data.map(d => d.cost);
            const effs = data.map(d => d.liters > 0 && d.dist > 0 ? (d.dist/d.liters).toFixed(1) : 0);

            if(charts.trend) {
                charts.trend.data.labels = labels;
                charts.trend.data.datasets[0].data = costs;
                charts.trend.data.datasets[1].data = effs;
                charts.trend.update();
            } else {
                charts.trend = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Gasto (R$)', data: costs, backgroundColor: '#06b6d4', yAxisID: 'y', order: 2 },
                            { label: 'Km/L', data: effs, borderColor: '#ef4444', backgroundColor:'#ef4444', type: 'line', yAxisID: 'y1', order: 1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { display: true, position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                            y1: { display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#ef4444' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                        }
                    }
                });
            }
        }

        // --- CALCULATIONS & UTILS ---
        function updateDashboardStats() {
            const tM = appData.maintenance.reduce((a, c) => a + Number(c.cost), 0);
            const tU = appData.garage.reduce((a, c) => a + Number(c.cost), 0);
            const tF = appData.fuel.reduce((a, c) => a + Number(c.total), 0);
            
            document.getElementById('totalMaintenance').innerText = formatCurrency(tM);
            document.getElementById('totalUpgrades').innerText = formatCurrency(tU);

            const fs = [...appData.fuel].sort((a, b) => a.km - b.km);
            let validKm = 0, validL = 0;
            for(let i=1; i<fs.length; i++) {
                if(fs[i].fullTank) {
                    const d = fs[i].km - fs[i-1].km;
                    if(d > 0) { validKm += d; validL += fs[i].liters; }
                }
            }
            if(validL > 0) document.getElementById('avgConsumption').innerText = (validKm/validL).toFixed(1) + " km/L";
            
            if(fs.length > 1) {
                const totalDist = fs[fs.length-1].km - fs[0].km;
                if(totalDist > 0) document.getElementById('costPerKm').innerText = formatCurrency(tF/totalDist) + "/km";
            }
        }

        function checkOilStatus() {
            const last = appData.maintenance.filter(m => m.type === 'Troca de Óleo').sort((a, b) => b.km - a.km)[0];
            const card = document.getElementById('oilStatusCard');
            if(!card) return;
            
            if(!last) {
                card.innerHTML = `<div class="flex justify-between items-center"><span class="text-yellow-500 font-bold">Sem registro de óleo</span><button onclick="openModal('maintenance')" class="text-xs border border-yellow-500 text-yellow-500 px-2 py-1 rounded">Add</button></div>`;
                card.className = "glass-panel p-4 rounded-xl border-l-4 border-yellow-500";
                return;
            }

            const diff = appData.odometer - last.km;
            const remain = OIL_KM - diff;
            const pct = Math.min(100, Math.max(0, (diff/OIL_KM)*100));
            
            let color = 'civic-cyan';
            let msg = 'Óleo OK';
            
            if(remain < 0) { color = 'red-500'; msg = `ATRASADO ${Math.abs(remain)}km`; card.classList.add('animate-pulse'); }
            else if(remain < 1000) { color = 'yellow-500'; msg = 'ATENÇÃO'; card.classList.remove('animate-pulse'); }
            else { card.classList.remove('animate-pulse'); }

            card.className = `glass-panel p-4 rounded-xl shadow-lg border-l-4 border-${color.replace('civic-cyan', 'cyan-500')}`;
            card.innerHTML = `
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-${color === 'civic-cyan' ? 'cyan-500' : color}">${msg}</span>
                    <span class="text-xs text-gray-400">Prox: ${(parseInt(last.km)+OIL_KM).toLocaleString()}</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-${color === 'civic-cyan' ? 'cyan-500' : color} h-2 rounded-full" style="width: ${pct}%"></div>
                </div>`;
        }

        // --- HANDLERS ---
        function openModal(type, index = null) {
            editingState = { type, index };
            const modal = document.getElementById(`${type}Modal`);
            const title = document.getElementById(`${type.charAt(0)}ModalTitle`);
            const btn = document.getElementById(`${type.charAt(0)}SubmitBtn`);
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (index !== null) {
                // Modo Edição
                const item = appData[type][index];
                title.innerText = `Editar ${type === 'maintenance' ? 'Manutenção' : (type === 'fuel' ? 'Abastecimento' : 'Item')}`;
                btn.innerText = 'Atualizar';
                
                // Preencher campos
                if (type === 'maintenance') {
                    document.getElementById('mDate').value = item.date;
                    document.getElementById('mKm').value = item.km;
                    document.getElementById('mType').value = item.type;
                    document.getElementById('mShop').value = item.shop;
                    document.getElementById('mCost').value = item.cost;
                    document.getElementById('mNotes').value = item.notes;
                } else if (type === 'fuel') {
                    document.getElementById('fDate').value = item.date;
                    document.getElementById('fKm').value = item.km;
                    document.getElementById('fLiters').value = item.liters;
                    document.getElementById('fPrice').value = item.pricePerLiter;
                    document.getElementById('fTotal').value = item.total;
                    document.getElementById('fFullTank').checked = item.fullTank;
                } else if (type === 'garage') {
                    document.getElementById('gItem').value = item.item;
                    document.getElementById('gStatus').value = item.status;
                    document.getElementById('gCost').value = item.cost;
                    document.getElementById('gLink').value = item.link;
                    document.getElementById('gImage').value = item.image;
                }
            } else {
                // Modo Criação
                title.innerText = `Novo ${type === 'maintenance' ? 'Registro' : (type === 'fuel' ? 'Abastecimento' : 'Item')}`;
                btn.innerText = 'Salvar';
                document.getElementById(`form${type.charAt(0).toUpperCase() + type.slice(1)}`).reset();
                setTodayDates();
            }
        }

        function editItem(type, index) {
            openModal(type, index);
        }

        function handleSave(type, item) {
            if (editingState.index !== null) {
                // Atualizar existente
                appData[type][editingState.index] = item;
            } else {
                // Criar novo
                appData[type].push(item);
            }

            if(type === 'fuel' || type === 'maintenance') {
                if(Number(item.km) > Number(appData.odometer)) appData.odometer = item.km;
            }
            
            localStorage.setItem(DB_KEYS.MAINT, JSON.stringify(appData.maintenance));
            localStorage.setItem(DB_KEYS.FUEL, JSON.stringify(appData.fuel));
            localStorage.setItem(DB_KEYS.GARAGE, JSON.stringify(appData.garage));
            localStorage.setItem(DB_KEYS.ODO, appData.odometer);
            
            renderDashboard(); 
            // Refresh listas
            if(type === 'maintenance') renderMaintenanceList();
            if(type === 'fuel') renderFuelList();
            if(type === 'garage') renderGarageList();
            
            return true;
        }

        function handleMaintenanceSubmit(e) {
            e.preventDefault();
            const item = {
                date: document.getElementById('mDate').value,
                km: document.getElementById('mKm').value,
                type: document.getElementById('mType').value,
                shop: document.getElementById('mShop').value,
                cost: parseFloat(document.getElementById('mCost').value),
                notes: document.getElementById('mNotes').value
            };
            handleSave('maintenance', item);
            toggleModal('maintenanceModal');
        }

        function handleFuelSubmit(e) {
            e.preventDefault();
            const item = {
                date: document.getElementById('fDate').value,
                km: parseFloat(document.getElementById('fKm').value),
                liters: parseFloat(document.getElementById('fLiters').value),
                total: parseFloat(document.getElementById('fTotal').value),
                pricePerLiter: parseFloat(document.getElementById('fPrice').value) || 0,
                fullTank: document.getElementById('fFullTank').checked
            };
            handleSave('fuel', item);
            toggleModal('fuelModal');
        }

        function handleGarageSubmit(e) {
            e.preventDefault();
            const item = {
                item: document.getElementById('gItem').value,
                status: document.getElementById('gStatus').value,
                cost: parseFloat(document.getElementById('gCost').value) || 0,
                link: document.getElementById('gLink').value,
                image: document.getElementById('gImage').value
            };
            handleSave('garage', item);
            toggleModal('garageModal');
        }

        function deleteItem(type, index) {
            if(confirm('Excluir?')) {
                appData[type].splice(index, 1);
                localStorage.setItem(DB_KEYS.MAINT, JSON.stringify(appData.maintenance));
                localStorage.setItem(DB_KEYS.FUEL, JSON.stringify(appData.fuel));
                localStorage.setItem(DB_KEYS.GARAGE, JSON.stringify(appData.garage));
                
                if(type === 'maintenance') renderMaintenanceList();
                if(type === 'fuel') renderFuelList();
                if(type === 'garage') renderGarageList();
                renderDashboard();
            }
        }

        // --- NAVIGATION & UI ---
        let ts = 0, te = 0;
        document.addEventListener('touchstart', e => ts = e.changedTouches[0].screenX, {passive:true});
        document.addEventListener('touchend', e => { te = e.changedTouches[0].screenX; handleSwipe(); }, {passive:true});
        
        function handleSwipe() {
            if(Math.abs(te-ts) < 60) return;
            const views = ['dashboard', 'maintenance', 'fuel', 'garage'];
            const cur = views.find(v => !document.getElementById('view-'+v).classList.contains('hidden'));
            const idx = views.indexOf(cur);
            if(te < ts && idx < 3) switchView(views[idx+1], 'right'); // Next
            if(te > ts && idx > 0) switchView(views[idx-1], 'left'); // Prev
        }

        function switchView(viewName, dir) {
            const views = document.querySelectorAll('.view-section');
            const next = document.getElementById('view-'+viewName);
            
            views.forEach(v => {
                if(!v.classList.contains('hidden')) {
                    v.classList.add('hidden');
                    v.classList.remove('animate-slide-left', 'animate-slide-right');
                }
            });
            
            next.classList.remove('hidden');
            if(dir) next.classList.add(dir === 'right' ? 'animate-slide-left' : 'animate-slide-right');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-civic-cyan', 'border-t-2', 'border-civic-cyan');
                el.classList.add('text-gray-500');
            });
            const btn = document.querySelector(`button[onclick="switchView('${viewName}')"]`);
            if(btn) { btn.classList.add('active', 'text-civic-cyan', 'border-t-2', 'border-civic-cyan'); btn.classList.remove('text-gray-500'); }

            if(viewName === 'maintenance') renderMaintenanceList();
            if(viewName === 'fuel') renderFuelList();
            if(viewName === 'garage') renderGarageList();
            if(viewName === 'dashboard') setTimeout(initOrUpdateCharts, 50);
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
            // Se fechou sem salvar, limpa estado de edição
            if(el.classList.contains('hidden')) editingState = { type: null, index: null };
        }

        function setFuelChartMode(m) { currentFuelMode = m; document.getElementById('btn-week').classList.toggle('active'); document.getElementById('btn-month').classList.toggle('active'); updateFuelTrendData(m); }
        function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        function formatDate(d) { return d ? d.split('-').reverse().join('/') : '-'; }
        function editOdometer() {
            const v = prompt("Novo KM:", appData.odometer);
            if(v && !isNaN(v)) { appData.odometer = v; localStorage.setItem(DB_KEYS.ODO, v); document.getElementById('headerOdometer').innerText = parseInt(v).toLocaleString(); checkOilStatus(); }
        }
        function calcFuelTotal(f) {
            const l = parseFloat(document.getElementById('fLiters').value), p = parseFloat(document.getElementById('fPrice').value), t = parseFloat(document.getElementById('fTotal').value);
            if((f==='liters'||f==='price') && !isNaN(l) && !isNaN(p)) document.getElementById('fTotal').value = (l*p).toFixed(2);
            else if(f==='total' && !isNaN(t) && !isNaN(p) && p>0) document.getElementById('fLiters').value = (t/p).toFixed(2);
        }
        function exportData() {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            a.download = "civic_bkp.json"; document.body.appendChild(a); a.click(); a.remove();
        }
        function setTodayDates() { const t = new Date().toISOString().split('T')[0]; document.getElementById('mDate').value = t; document.getElementById('fDate').value = t; }
    </script>
</body>
</html>
