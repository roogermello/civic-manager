<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Civic Manager G9</title>
    
    <!-- Configurações de Web App (PWA Feeling) -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Civic Mgr">
    
    <!-- Ícone para Home Screen (Genérico de Carro) -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/55/55283.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/55/55283.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuração do Tema (Civic Dashboard Palette) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        civic: {
                            dark: '#0f172a',    // Fundo Painel
                            panel: '#1e293b',   // Cards
                            cyan: '#06b6d4',    // Detalhes (i-MID)
                            red: '#ef4444',     // Alertas
                            text: '#e2e8f0'     // Texto
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos globais e animações */
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            padding-bottom: 90px; /* Aumentado para compensar safe areas em iPhones */
            -webkit-tap-highlight-color: transparent; /* Remove highlight azul ao tocar em botões no mobile */
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Input Styles */
        input, select, textarea {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            font-size: 16px; /* Evita zoom automático no iOS ao focar no input */
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
        }

        /* Checkbox Custom Style */
        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #22c55e;
            cursor: pointer;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 3px;
        }
        
        /* Highlight Crítico */
        .critical-row {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .nav-item.active {
            color: #06b6d4;
            border-top: 2px solid #06b6d4;
        }
        
        /* Toggles */
        .toggle-btn {
            @apply px-3 py-1 text-xs font-bold rounded-full transition-colors border border-gray-600 text-gray-400;
        }
        .toggle-btn.active {
            @apply bg-civic-cyan text-slate-900 border-civic-cyan;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }
        .toast {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #06b6d4;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Ajuste para Notch/Ilha Dinâmica em iPhones */
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Header -->
    <header class="p-4 flex justify-between items-center bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-car-side text-civic-cyan text-2xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wider">CIVIC <span class="text-civic-cyan">MANAGER</span></h1>
                <p class="text-xs text-gray-400">Geração 9</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xs text-gray-400">Hodômetro</p>
            <div class="flex items-center gap-2" onclick="editOdometer()">
                <span id="headerOdometer" class="font-mono text-xl font-bold text-white">0</span> <span class="text-xs">km</span>
                <i class="fa-solid fa-pen text-xs text-gray-500 cursor-pointer"></i>
            </div>
        </div>
    </header>

    <!-- Main Content Containers -->
    <main class="p-4 max-w-3xl mx-auto">
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view-section space-y-4">
            
            <!-- ALERTA DE ÓLEO (NOVO WIDGET) -->
            <div id="oilStatusCard" class="glass-panel p-4 rounded-xl shadow-lg border-l-4 transition-all duration-300">
                <!-- Conteúdo injetado via JS -->
                <div class="flex justify-between items-center animate-pulse">
                    <span class="text-gray-400">Carregando status do óleo...</span>
                </div>
            </div>

            <!-- Cards de Resumo -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-4 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <p class="text-xs text-gray-400 uppercase">Manutenção</p>
                    <h3 class="text-xl font-bold mt-1 text-white" id="totalMaintenance">R$ 0,00</h3>
                </div>
                <div class="glass-panel p-4 rounded-xl shadow-lg border-t-4 border-purple-500">
                    <p class="text-xs text-gray-400 uppercase">Upgrades</p>
                    <h3 class="text-xl font-bold mt-1 text-white" id="totalUpgrades">R$ 0,00</h3>
                </div>
                <div class="glass-panel p-4 rounded-xl shadow-lg border-t-4 border-green-500 col-span-2">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-gray-400 uppercase">Eficiência Média (Geral)</p>
                            <h3 class="text-2xl font-bold mt-1 text-white" id="avgConsumption">-- km/L</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Custo/KM</p>
                            <p class="text-lg font-bold text-green-400" id="costPerKm">R$ 0,00</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Evolução -->
            <div class="glass-panel p-4 rounded-xl mt-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-300">Evolução de Combustível</h3>
                    <div class="flex gap-2">
                        <button onclick="setFuelChartMode('week')" id="btn-week" class="toggle-btn">Semana</button>
                        <button onclick="setFuelChartMode('month')" id="btn-month" class="toggle-btn active">Mês</button>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="fuelTrendChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Distribuição -->
            <div class="glass-panel p-4 rounded-xl mt-4">
                <h3 class="text-sm font-bold mb-4 text-gray-300">Distribuição de Gastos</h3>
                <canvas id="expenseChart" height="200"></canvas>
            </div>

            <!-- Botão Backup -->
            <button onclick="exportData()" class="w-full mt-6 py-3 text-xs text-gray-500 hover:text-white border border-dashed border-gray-700 rounded-lg">
                <i class="fa-solid fa-download mr-2"></i> Exportar Dados (Backup JSON)
            </button>
        </section>

        <!-- MANUTENÇÃO VIEW -->
        <section id="view-maintenance" class="view-section hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-civic-cyan">Histórico de Serviços</h2>
                <button onclick="toggleModal('maintenanceModal')" class="bg-civic-cyan text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-cyan-400 transition">
                    <i class="fa-solid fa-plus mr-1"></i> Novo
                </button>
            </div>
            
            <div id="maintenanceList" class="space-y-3 pb-20">
                <!-- Items injetados via JS -->
            </div>
        </section>

        <!-- ABASTECIMENTO VIEW -->
        <section id="view-fuel" class="view-section hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-green-400">Controle de Combustível</h2>
                <button onclick="toggleModal('fuelModal')" class="bg-green-500 text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-green-400 transition">
                    <i class="fa-solid fa-gas-pump mr-1"></i> Abastecer
                </button>
            </div>

            <div id="fuelList" class="space-y-3 pb-20">
                <!-- Items injetados via JS -->
            </div>
        </section>

        <!-- UPGRADES VIEW -->
        <section id="view-garage" class="view-section hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-purple-400">Garagem & Upgrades</h2>
                <button onclick="toggleModal('garageModal')" class="bg-purple-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-400 transition">
                    <i class="fa-solid fa-screwdriver-wrench mr-1"></i> Adicionar
                </button>
            </div>

            <div id="garageList" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-20">
                <!-- Items injetados via JS -->
            </div>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 flex justify-around py-3 z-50 shadow-2xl pb-[env(safe-area-inset-bottom)]">
        <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center text-gray-500 w-1/4">
            <i class="fa-solid fa-chart-pie mb-1 text-lg"></i>
            <span class="text-[10px]">Resumo</span>
        </button>
        <button onclick="switchView('maintenance')" class="nav-item flex flex-col items-center text-gray-500 w-1/4">
            <i class="fa-solid fa-wrench mb-1 text-lg"></i>
            <span class="text-[10px]">Manutenção</span>
        </button>
        <button onclick="switchView('fuel')" class="nav-item flex flex-col items-center text-gray-500 w-1/4">
            <i class="fa-solid fa-gas-pump mb-1 text-lg"></i>
            <span class="text-[10px]">Combustível</span>
        </button>
        <button onclick="switchView('garage')" class="nav-item flex flex-col items-center text-gray-500 w-1/4">
            <i class="fa-solid fa-basket-shopping mb-1 text-lg"></i>
            <span class="text-[10px]">Upgrades</span>
        </button>
    </nav>

    <!-- MODALS (Forms) -->
    
    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 relative animate-[fadeIn_0.2s_ease-out]">
            <button onclick="toggleModal('maintenanceModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4">Nova Manutenção</h3>
            <form id="formMaintenance" onsubmit="handleMaintenanceSubmit(event)" class="space-y-3">
                <input type="date" id="mDate" required>
                <input type="number" id="mKm" placeholder="Quilometragem" required>
                <select id="mType" required>
                    <option value="" disabled selected>Tipo de Serviço</option>
                    <option value="Troca de Óleo">Troca de Óleo Motor</option>
                    <option value="Filtros">Filtros (Ar/Comb/Cabine)</option>
                    <option value="Câmbio Automático">Câmbio Automático (CRÍTICO)</option>
                    <option value="Freios">Freios</option>
                    <option value="Suspensão">Suspensão</option>
                    <option value="Pneus">Pneus</option>
                    <option value="Outros">Outros</option>
                </select>
                <input type="text" id="mShop" placeholder="Oficina / Mecânico">
                <input type="number" step="0.01" id="mCost" placeholder="Valor Total (R$)" required>
                <textarea id="mNotes" rows="2" placeholder="Observações (Peças usadas, marca do óleo...)"></textarea>
                <button type="submit" class="w-full bg-civic-cyan text-slate-900 font-bold py-3 rounded-lg mt-2 active:scale-95 transition-transform">Salvar Registro</button>
            </form>
        </div>
    </div>

    <!-- Fuel Modal -->
    <div id="fuelModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 relative animate-[fadeIn_0.2s_ease-out]">
            <button onclick="toggleModal('fuelModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4">Novo Abastecimento</h3>
            <form id="formFuel" onsubmit="handleFuelSubmit(event)" class="space-y-3">
                <input type="date" id="fDate" required>
                <input type="number" id="fKm" placeholder="KM Atual" required>
                
                <!-- Campos de Cálculo -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] text-gray-400 pl-1">Litros</label>
                        <input type="number" step="0.01" id="fLiters" placeholder="0.00 L" oninput="calcFuelTotal('liters')" required>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 pl-1">Preço/L (R$)</label>
                        <input type="number" step="0.001" id="fPrice" placeholder="R$ 0.00" oninput="calcFuelTotal('price')">
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] text-gray-400 pl-1">Total Pago (R$)</label>
                    <input type="number" step="0.01" id="fTotal" placeholder="R$ 0.00" oninput="calcFuelTotal('total')" required>
                </div>

                <!-- Toggle Tanque Cheio -->
                <div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700 mt-2">
                    <input type="checkbox" id="fFullTank" class="w-5 h-5 accent-green-500 rounded focus:ring-green-500">
                    <label for="fFullTank" class="text-sm text-gray-300 cursor-pointer flex-1 select-none">
                        Tanque Cheio?
                        <span class="block text-[10px] text-gray-500">Marque para cálculo de consumo (km/L)</span>
                    </label>
                    <i class="fa-solid fa-gas-pump text-green-500 text-lg"></i>
                </div>

                <button type="submit" class="w-full bg-green-500 text-slate-900 font-bold py-3 rounded-lg mt-2 active:scale-95 transition-transform">Salvar Abastecimento</button>
            </form>
        </div>
    </div>

    <!-- Garage Modal -->
    <div id="garageModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 relative animate-[fadeIn_0.2s_ease-out]">
            <button onclick="toggleModal('garageModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4">Novo Item / Upgrade</h3>
            <form id="formGarage" onsubmit="handleGarageSubmit(event)" class="space-y-3">
                <input type="text" id="gItem" placeholder="Nome do Item (ex: Multimídia)" required>
                <select id="gStatus" required>
                    <option value="Desejo">Lista de Desejos</option>
                    <option value="Comprado">Comprado (Aguardando)</option>
                    <option value="Instalado">Instalado</option>
                </select>
                <input type="number" step="0.01" id="gCost" placeholder="Custo Estimado/Real (R$)">
                <input type="url" id="gLink" placeholder="Link de Compra (URL)">
                <input type="url" id="gImage" placeholder="Link da Imagem (URL)">
                <button type="submit" class="w-full bg-purple-500 text-white font-bold py-3 rounded-lg mt-2 active:scale-95 transition-transform">Salvar Item</button>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const DB_KEYS = {
            MAINTENANCE: 'civic_maintenance',
            FUEL: 'civic_fuel',
            GARAGE: 'civic_garage',
            ODOMETER: 'civic_odometer'
        };

        const OIL_INTERVAL_KM = 10000;
        const OIL_ALERT_INTERVAL = 2000;

        let appData = {
            maintenance: JSON.parse(localStorage.getItem(DB_KEYS.MAINTENANCE)) || [],
            fuel: JSON.parse(localStorage.getItem(DB_KEYS.FUEL)) || [],
            garage: JSON.parse(localStorage.getItem(DB_KEYS.GARAGE)) || [],
            odometer: localStorage.getItem(DB_KEYS.ODOMETER) || 0
        };

        let expenseChartInstance = null;
        let trendChartInstance = null;
        let currentFuelMode = 'month'; // 'week' or 'month'

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderAll();
            setTodayDates();
            updateFuelChart(currentFuelMode); // Init trend chart
            checkOilStatus(); // Inicializa o card de óleo
        });

        function saveData() {
            localStorage.setItem(DB_KEYS.MAINTENANCE, JSON.stringify(appData.maintenance));
            localStorage.setItem(DB_KEYS.FUEL, JSON.stringify(appData.fuel));
            localStorage.setItem(DB_KEYS.GARAGE, JSON.stringify(appData.garage));
            localStorage.setItem(DB_KEYS.ODOMETER, appData.odometer);
            renderAll();
            updateFuelChart(currentFuelMode);
            checkOilStatus(); // Atualiza o status do óleo após salvar
        }

        function setTodayDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('mDate').value = today;
            document.getElementById('fDate').value = today;
        }

        // --- UI UTILS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let icon = 'fa-info-circle';
            let borderColor = 'border-civic-cyan';
            
            if(type === 'warning') { icon = 'fa-exclamation-triangle text-yellow-500'; borderColor = 'border-yellow-500'; }
            if(type === 'danger') { icon = 'fa-bell text-red-500 animate-pulse'; borderColor = 'border-red-500'; }
            if(type === 'success') { icon = 'fa-check-circle text-green-500'; borderColor = 'border-green-500'; }

            toast.className = `toast border-l-4 ${borderColor}`;
            toast.innerHTML = `<i class="fa-solid ${icon} text-xl"></i> <div>${message}</div>`;
            
            container.appendChild(toast);
            
            // Trigger animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            // Remove after 4s
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // --- CORE FUNCTIONS ---

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(dateString) {
            if(!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function editOdometer() {
            const newKm = prompt("Atualizar Hodômetro (KM Total):", appData.odometer);
            if (newKm && !isNaN(newKm)) {
                appData.odometer = parseInt(newKm);
                saveData();
            }
        }

        // --- LOGICA DE OLEO (NOVA) ---
        function getLastOilChange() {
            // Filtra e ordena (mais recente primeiro)
            const oilChanges = appData.maintenance
                .filter(m => m.type === 'Troca de Óleo')
                .sort((a, b) => b.km - a.km);
            
            return oilChanges.length > 0 ? oilChanges[0] : null;
        }

        function checkOilStatus() {
            const lastOil = getLastOilChange();
            const card = document.getElementById('oilStatusCard');
            const currentKm = parseInt(appData.odometer);

            // Caso 1: Sem registro de troca
            if (!lastOil) {
                // Se não tem troca registrada, mas sabemos que está atrasado (caso manual do usuário)
                // Vamos assumir que ele vai registrar a troca nova. 
                // Por enquanto, mostra alerta para registrar a primeira.
                card.className = "glass-panel p-4 rounded-xl shadow-lg border-l-4 border-yellow-500";
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-yellow-500"><i class="fa-solid fa-oil-can mr-2"></i>Status do Óleo</h4>
                            <p class="text-xs text-gray-400">Nenhuma troca registrada.</p>
                        </div>
                        <button onclick="toggleModal('maintenanceModal')" class="text-xs bg-yellow-500/20 text-yellow-500 px-3 py-1 rounded border border-yellow-500">Registrar</button>
                    </div>
                `;
                return;
            }

            // Caso 2: Calculando status
            const kmSinceChange = currentKm - lastOil.km;
            const kmRemaining = OIL_INTERVAL_KM - kmSinceChange;
            const percent = Math.min(100, Math.max(0, (kmSinceChange / OIL_INTERVAL_KM) * 100));
            
            let statusHTML = '';
            let borderClass = '';
            let progressColor = '';
            let iconClass = '';

            // Lógica de Estado
            if (kmRemaining < 0) {
                // ATRASADO
                const overdueKm = Math.abs(kmRemaining);
                borderClass = 'border-red-500 bg-red-900/10';
                progressColor = 'bg-red-500';
                iconClass = 'fa-solid fa-triangle-exclamation text-red-500 animate-pulse';
                
                statusHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-red-500 flex items-center gap-2">
                                <i class="${iconClass}"></i> ATRASADO
                            </h4>
                            <p class="text-xs text-red-300">Passou ${overdueKm.toLocaleString()} km do limite!</p>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-gray-400">Troca feita em</p>
                             <p class="font-bold text-white">${parseInt(lastOil.km).toLocaleString()} km</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                        <div class="${progressColor} h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                    <p class="text-[10px] text-center mt-1 text-red-400 font-bold">TROQUE IMEDIATAMENTE</p>
                `;
            } else if (kmRemaining <= 1000) {
                // ATENÇÃO (< 1000km)
                borderClass = 'border-yellow-500';
                progressColor = 'bg-yellow-500';
                
                statusHTML = `
                    <div class="flex justify-between items-start mb-2">
                         <div>
                            <h4 class="font-bold text-yellow-500"><i class="fa-solid fa-clock mr-1"></i> Atenção</h4>
                            <p class="text-xs text-gray-300">Faltam <b>${kmRemaining.toLocaleString()} km</b></p>
                        </div>
                         <div class="text-right">
                             <p class="text-xs text-gray-400">Próxima em</p>
                             <p class="font-bold text-white">${(parseInt(lastOil.km) + OIL_INTERVAL_KM).toLocaleString()} km</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                        <div class="${progressColor} h-2.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                `;
            } else {
                // OK
                borderClass = 'border-civic-cyan';
                progressColor = 'bg-civic-cyan';
                
                statusHTML = `
                    <div class="flex justify-between items-start mb-2">
                         <div>
                            <h4 class="font-bold text-civic-cyan"><i class="fa-solid fa-check-circle mr-1"></i> Óleo OK</h4>
                            <p class="text-xs text-gray-300">Rodou ${kmSinceChange.toLocaleString()} km</p>
                        </div>
                         <div class="text-right">
                             <p class="text-xs text-gray-400">Próxima em</p>
                             <p class="font-bold text-white">${(parseInt(lastOil.km) + OIL_INTERVAL_KM).toLocaleString()} km</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                        <div class="${progressColor} h-2.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                     <p class="text-[10px] text-right mt-1 text-gray-500">Resta: ${kmRemaining.toLocaleString()} km</p>
                `;
            }

            card.className = `glass-panel p-4 rounded-xl shadow-lg border-l-4 transition-colors duration-300 ${borderClass}`;
            card.innerHTML = statusHTML;
        }

        // Função de Alerta de 2000km (Chamada ao atualizar Hodometro)
        function checkOilMilestones(oldKm, newKm) {
            const lastOil = getLastOilChange();
            if (!lastOil) return;

            const oilBaseKm = lastOil.km;
            const distOld = oldKm - oilBaseKm;
            const distNew = newKm - oilBaseKm;

            // Se a distância atual for negativa (erro de digitação ou troca futura?), ignora
            if (distNew < 0) return;

            // Verifica se cruzamos um múltiplo de 2000
            // Ex: Old = 1900, New = 2100 -> Cruzou 2000
            // Ex: Old = 3900, New = 4100 -> Cruzou 4000
            
            const milestoneOld = Math.floor(distOld / OIL_ALERT_INTERVAL);
            const milestoneNew = Math.floor(distNew / OIL_ALERT_INTERVAL);

            if (milestoneNew > milestoneOld && milestoneNew > 0) {
                // CRUZOU UM MILESTONE!
                const remaining = OIL_INTERVAL_KM - distNew;
                
                if (remaining > 0) {
                    showToast(`Alerta de Óleo: Você rodou mais 2.000km. Faltam ${remaining.toLocaleString()} km para a troca.`, 'warning');
                } else {
                    showToast(`CRÍTICO: Você passou ${Math.abs(remaining).toLocaleString()} km do ponto de troca!`, 'danger');
                }
            }
        }


        // --- CALCULO AUTOMATICO NO FORMULARIO ---
        function calcFuelTotal(changedField) {
            const litersEl = document.getElementById('fLiters');
            const priceEl = document.getElementById('fPrice');
            const totalEl = document.getElementById('fTotal');
            
            const liters = parseFloat(litersEl.value);
            const price = parseFloat(priceEl.value);
            const total = parseFloat(totalEl.value);

            // Logica: Se mudou litros ou preço -> Calcula Total (prioridade)
            if (changedField === 'liters' || changedField === 'price') {
                if (!isNaN(liters) && !isNaN(price)) {
                    totalEl.value = (liters * price).toFixed(2);
                }
            }
            // Se mudou total -> Tenta calcular litros se tiver preço
            else if (changedField === 'total') {
                if (!isNaN(total) && !isNaN(price) && price > 0) {
                    litersEl.value = (total / price).toFixed(2);
                }
            }
        }

        // --- FUEL TREND LOGIC ---
        function setFuelChartMode(mode) {
            currentFuelMode = mode;
            // Update buttons style
            document.getElementById('btn-week').classList.toggle('active', mode === 'week');
            document.getElementById('btn-month').classList.toggle('active', mode === 'month');
            updateFuelChart(mode);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function updateFuelChart(mode) {
            const ctx = document.getElementById('fuelTrendChart').getContext('2d');
            
            // 1. Prepare raw data with distance info
            let sortedFuel = [...appData.fuel].sort((a, b) => new Date(a.date) - new Date(b.date));
            let enrichedFuel = sortedFuel.map((item, i) => {
                let dist = 0;
                if(i > 0) dist = item.km - sortedFuel[i-1].km;
                if(dist < 0) dist = 0; 
                
                let dateObj = new Date(item.date);
                let key = '';
                let label = '';

                if(mode === 'month') {
                    key = item.date.substring(0, 7); // YYYY-MM
                    label = dateObj.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                } else {
                    const wk = getWeekNumber(dateObj);
                    const yr = dateObj.getFullYear();
                    key = `${yr}-W${wk}`;
                    label = `Sem ${wk}`;
                }

                return { ...item, dist, key, label };
            });

            // 2. Group by Key
            let grouped = {};
            enrichedFuel.forEach(item => {
                if(!grouped[item.key]) {
                    grouped[item.key] = { 
                        label: item.label, 
                        totalCost: 0, 
                        totalLiters: 0, 
                        totalDist: 0,
                        date: item.date
                    };
                }
                grouped[item.key].totalCost += item.total;
                grouped[item.key].totalLiters += item.liters;
                grouped[item.key].totalDist += item.dist;
            });

            // 3. Convert to array and calculate stats
            let chartData = Object.values(grouped).sort((a, b) => new Date(a.date) - new Date(b.date));

            // 4. Slice last 4
            if(chartData.length > 4) {
                chartData = chartData.slice(chartData.length - 4);
            }

            // 5. Extract arrays for Chart.js
            const labels = chartData.map(d => d.label);
            const costs = chartData.map(d => d.totalCost);
            const efficiencies = chartData.map(d => {
                if(d.totalLiters === 0) return 0;
                return d.totalDist > 0 ? (d.totalDist / d.totalLiters).toFixed(1) : 0;
            });

            if(trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gasto (R$)',
                            data: costs,
                            backgroundColor: '#06b6d4',
                            order: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Consumo (km/L)',
                            data: efficiencies,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef4444',
                            type: 'line',
                            order: 1,
                            borderWidth: 2,
                            pointRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#ef4444' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } }
                    }
                }
            });
        }


        // --- RENDER LOGIC ---

        function renderAll() {
            document.getElementById('headerOdometer').innerText = parseInt(appData.odometer).toLocaleString('pt-BR');
            renderMaintenance();
            renderFuel();
            renderGarage();
            renderDashboardStats();
            if(!document.getElementById('view-dashboard').classList.contains('hidden')) {
                updateExpenseChart();
                updateFuelChart(currentFuelMode);
            }
        }

        function renderMaintenance() {
            const container = document.getElementById('maintenanceList');
            container.innerHTML = '';
            
            const sorted = [...appData.maintenance].sort((a, b) => new Date(b.date) - new Date(a.date));

            sorted.forEach((item, index) => {
                const isCritical = item.type === 'Câmbio Automático';
                const borderClass = isCritical ? 'critical-row' : 'border-l-4 border-blue-500';
                
                const html = `
                    <div class="glass-panel p-3 rounded-lg relative ${borderClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-xs text-gray-400 font-mono">${formatDate(item.date)} • ${parseInt(item.km).toLocaleString()} km</span>
                                <h4 class="font-bold text-white ${isCritical ? 'text-red-400' : ''}">${item.type}</h4>
                                <p class="text-sm text-gray-300">${item.shop || 'Oficina não inf.'}</p>
                                ${item.notes ? `<p class="text-xs text-gray-500 italic mt-1">"${item.notes}"</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-civic-cyan">${formatCurrency(item.cost)}</p>
                                <button onclick="deleteItem('maintenance', ${appData.maintenance.indexOf(item)})" class="text-xs text-red-500 mt-2 opacity-50 hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            if(sorted.length === 0) container.innerHTML = '<p class="text-center text-gray-500 mt-10">Nenhum registro de manutenção.</p>';
        }

        function renderFuel() {
            const container = document.getElementById('fuelList');
            container.innerHTML = '';
            
            // Ordenar por KM (maior KM primeiro)
            const sorted = [...appData.fuel].sort((a, b) => b.km - a.km);

            sorted.forEach((item, index) => {
                let efficiency = '<span class="text-gray-600">-</span>';
                const prevItem = sorted[index + 1]; 
                
                // Cálculo de eficiencia: Só calcula se o ATUAL for tanque cheio
                if (item.fullTank && prevItem) {
                    const dist = item.km - prevItem.km;
                    const kmL = dist / item.liters;
                    efficiency = kmL.toFixed(1) + ' km/L';
                }

                const tankIcon = item.fullTank 
                    ? '<i class="fa-solid fa-circle-check text-green-500 text-xs" title="Tanque Cheio"></i>' 
                    : '<i class="fa-regular fa-circle text-gray-600 text-xs" title="Parcial"></i>';

                const html = `
                    <div class="glass-panel p-3 rounded-lg border-l-4 border-green-500 flex justify-between items-center">
                        <div>
                            <span class="text-xs text-gray-400 font-mono flex items-center gap-1">
                                ${formatDate(item.date)} • ${parseInt(item.km).toLocaleString()} km
                                ${tankIcon}
                            </span>
                            <div class="flex items-baseline gap-2 mt-1">
                                <h4 class="font-bold text-white">${item.liters} L</h4>
                                <span class="text-xs text-green-400 font-bold bg-green-900/30 px-2 py-0.5 rounded">${efficiency}</span>
                            </div>
                            ${item.pricePerLiter ? `<p class="text-[10px] text-gray-500 mt-0.5">R$ ${item.pricePerLiter}/L</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-white">${formatCurrency(item.total)}</p>
                            <button onclick="deleteItem('fuel', ${appData.fuel.indexOf(item)})" class="text-xs text-red-500 mt-1 opacity-50 hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
            
             if(sorted.length === 0) container.innerHTML = '<p class="text-center text-gray-500 mt-10">Nenhum abastecimento registrado.</p>';
        }

        function renderGarage() {
            const container = document.getElementById('garageList');
            container.innerHTML = '';

            appData.garage.forEach((item, index) => {
                let statusColor = 'bg-gray-600';
                if(item.status === 'Comprado') statusColor = 'bg-yellow-600';
                if(item.status === 'Instalado') statusColor = 'bg-purple-600';

                const html = `
                    <div class="glass-panel rounded-lg overflow-hidden flex flex-col h-full">
                        ${item.image ? `<div class="h-32 bg-cover bg-center" style="background-image: url('${item.image}')"></div>` : `<div class="h-24 bg-slate-800 flex items-center justify-center text-slate-600"><i class="fa-solid fa-image text-3xl"></i></div>`}
                        <div class="p-3 flex-1 flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] uppercase font-bold text-white px-2 py-0.5 rounded ${statusColor}">${item.status}</span>
                                <button onclick="deleteItem('garage', ${index})" class="text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <h4 class="font-bold text-white leading-tight mb-1">${item.item}</h4>
                            <p class="text-civic-cyan font-bold mt-auto">${item.cost > 0 ? formatCurrency(item.cost) : '-'}</p>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="text-xs text-blue-400 mt-2 hover:underline"><i class="fa-solid fa-external-link-alt"></i> Ver Link</a>` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            if(appData.garage.length === 0) container.innerHTML = '<p class="text-center text-gray-500 col-span-2 mt-10">Garagem vazia. Adicione seus sonhos!</p>';
        }

        function renderDashboardStats() {
            // Totals
            const totalMaint = appData.maintenance.reduce((acc, curr) => acc + Number(curr.cost), 0);
            const totalMods = appData.garage.reduce((acc, curr) => acc + Number(curr.cost), 0);
            const totalFuel = appData.fuel.reduce((acc, curr) => acc + Number(curr.total), 0);
            
            document.getElementById('totalMaintenance').innerText = formatCurrency(totalMaint);
            document.getElementById('totalUpgrades').innerText = formatCurrency(totalMods);

            // Fuel Logic (Considerando apenas intervalos válidos de tanque cheio para média geral)
            const fuelSorted = [...appData.fuel].sort((a, b) => a.km - b.km); // Crescente
            
            let totalKmValidos = 0;
            let totalLitrosValidos = 0;

            for(let i = 1; i < fuelSorted.length; i++) {
                const current = fuelSorted[i];
                const prev = fuelSorted[i-1];
                
                // Se o atual foi tanque cheio, o consumo é: (Distancia percorrida / Litros que entraram agora)
                // Isso assume que os litros que entraram agora repuseram o gasto desde o anterior.
                if(current.fullTank) {
                    const dist = current.km - prev.km;
                    if(dist > 0) {
                        totalKmValidos += dist;
                        totalLitrosValidos += parseFloat(current.liters);
                    }
                }
            }

            if(totalLitrosValidos > 0) {
                const avg = totalKmValidos / totalLitrosValidos;
                document.getElementById('avgConsumption').innerText = avg.toFixed(1) + " km/L";
                
                // Custo por KM Geral (Gasto Total / KM Total Rodado desde o início dos registros)
                const first = fuelSorted[0];
                const last = fuelSorted[fuelSorted.length - 1];
                const totalDist = last.km - first.km;
                if (totalDist > 0) {
                    const costKm = totalFuel / totalDist;
                    document.getElementById('costPerKm').innerText = formatCurrency(costKm) + "/km";
                }
            }
        }

        function updateExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            const totalMaint = appData.maintenance.reduce((acc, curr) => acc + Number(curr.cost), 0);
            const totalMods = appData.garage.reduce((acc, curr) => acc + Number(curr.cost), 0);
            const totalFuel = appData.fuel.reduce((acc, curr) => acc + Number(curr.total), 0);

            if(expenseChartInstance) expenseChartInstance.destroy();

            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Manutenção', 'Combustível', 'Upgrades'],
                    datasets: [{
                        data: [totalMaint, totalFuel, totalMods],
                        backgroundColor: ['#3b82f6', '#22c55e', '#a855f7'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // --- HANDLERS ---

        function handleMaintenanceSubmit(e) {
            e.preventDefault();
            const newItem = {
                date: document.getElementById('mDate').value,
                km: document.getElementById('mKm').value,
                type: document.getElementById('mType').value,
                shop: document.getElementById('mShop').value,
                cost: parseFloat(document.getElementById('mCost').value),
                notes: document.getElementById('mNotes').value
            };
            appData.maintenance.push(newItem);
            
            // Atualizar hodômetro se maior
            if(Number(newItem.km) > Number(appData.odometer)) appData.odometer = newItem.km;

            saveData();
            toggleModal('maintenanceModal');
            e.target.reset();
        }

        function handleFuelSubmit(e) {
            e.preventDefault();
            const newKm = parseFloat(document.getElementById('fKm').value);
            const oldKm = appData.odometer;

            const newItem = {
                date: document.getElementById('fDate').value,
                km: newKm,
                liters: parseFloat(document.getElementById('fLiters').value),
                total: parseFloat(document.getElementById('fTotal').value),
                pricePerLiter: parseFloat(document.getElementById('fPrice').value) || 0,
                fullTank: document.getElementById('fFullTank').checked
            };
            appData.fuel.push(newItem);

            // Verificar milestones de óleo ANTES de salvar o novo odometro
            checkOilMilestones(oldKm, newKm);

            // Atualizar hodômetro se maior
            if(Number(newItem.km) > Number(appData.odometer)) appData.odometer = newItem.km;

            saveData();
            toggleModal('fuelModal');
            e.target.reset();
        }

        function handleGarageSubmit(e) {
            e.preventDefault();
            const newItem = {
                item: document.getElementById('gItem').value,
                status: document.getElementById('gStatus').value,
                cost: parseFloat(document.getElementById('gCost').value) || 0,
                link: document.getElementById('gLink').value,
                image: document.getElementById('gImage').value
            };
            appData.garage.push(newItem);
            saveData();
            toggleModal('garageModal');
            e.target.reset();
        }

        function deleteItem(type, index) {
            if(confirm('Tem certeza que deseja excluir este registro?')) {
                appData[type].splice(index, 1);
                saveData();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "civic_manager_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>
